<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MP3 播放器 (本地与云端)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
          darkMode: 'class', 
          theme: { extend: { maxWidth: { '9xl': '96rem' } } }
        }
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsmediatags/3.9.5/jsmediatags.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
        html, body { height: 100%; overflow: hidden; }
        body { font-family: 'Inter', sans-serif; display: flex; align-items: center; justify-content: center; transition: background-color 0.3s ease, color 0.3s ease; }
        input[type="file"]::-webkit-file-upload-button,
        input[type="file"]::file-selector-button { display: none; }
        .lyrics-container::-webkit-scrollbar { width: 8px; }
        .lyrics-container::-webkit-scrollbar-track { background: #f1f5f9; }
        .lyrics-container::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 4px; }
        .dark .lyrics-container::-webkit-scrollbar-track { background: #000000; }
        .dark .lyrics-container::-webkit-scrollbar-thumb { background: #475569; }
        .lyrics-container p { padding: 10px 16px; border-radius: 8px; transition: all 0.3s ease; text-align: center; color: #000000; }
        .dark .lyrics-container p { color: #c4c4c4; }
        .lyrics-container p[data-time]:hover { background-color: #f0f9ff; cursor: pointer; }
        .dark .lyrics-container p[data-time]:hover { background-color: #8f2020; }
        .lyrics-container p.active { background-color: #e0f2fe; color: #0c4a6e; font-weight: 700; transform: scale(1.02); }
        .dark .lyrics-container p.active { background-color: #2a1e25; color: #ffffff; }
        input[type="range"] { -webkit-appearance: none; appearance: none; width: 100%; height: 6px; background: #e2e8f0; border-radius: 3px; outline: none; opacity: 0.7; transition: opacity .2s; }
        input[type="range"]:hover { opacity: 1; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 16px; height: 16px; background: #000000; cursor: pointer; border-radius: 50%; }
        input[type="range"]::-moz-range-thumb { width: 16px; height: 16px; background: #3b82f6; cursor: pointer; border-radius: 50%; }
        .dark input[type="range"] { background: #261f1f; }
        .dark input[type="range"]::-webkit-slider-thumb { background: #c44b18; }
        .dark input[type="range"]::-moz-range-thumb { background: #a7c61d; }
        #playlist-items li { padding: 8px 12px; cursor: pointer; border-bottom: 1px solid #e5e7eb; transition: background-color 0.2s ease; }
        .dark #playlist-items li { border-bottom: 1px solid #374151; }
        #playlist-items li:hover { background-color: #f3f4f6; }
        .dark #playlist-items li:hover { background-color: #1f2937; }
        #playlist-items li.playing { background-color: #dbeafe; color: #1e40af; font-weight: 600; }
        .dark #playlist-items li.playing { background-color: #1e3a8a; color: #eff6ff; }
        #playlist-container { max-height: 200px; overflow-y: auto; }
        #playlist-container::-webkit-scrollbar { width: 6px; }
        #playlist-container::-webkit-scrollbar-track { background: #e5e7eb; }
        #playlist-container::-webkit-scrollbar-thumb { background: #9ca3af; border-radius: 3px; }
        .dark #playlist-container::-webkit-scrollbar-track { background: #374151; }
        .dark #playlist-container::-webkit-scrollbar-thumb { background: #6b7280; }
    </style>
</head>
<body class="bg-slate-100 dark:bg-slate-900">

    <div id="main-container" class="w-11/12 max-w-7xl h-full mx-auto bg-white dark:bg-black/80 rounded-xl shadow-2xl flex flex-col p-4 sm:p-6 transition-colors duration-300">
        <div id="upload-overlay" class="absolute inset-0 bg-white/80 dark:bg-slate-900/80 backdrop-blur-sm flex items-center justify-center z-20 p-4 rounded-xl">
             <label for="fileInput" class="w-full max-w-md cursor-pointer bg-blue-50 hover:bg-blue-100 dark:bg-slate-700 dark:hover:bg-slate-600 border-2 border-dashed border-blue-300 dark:border-blue-700 rounded-lg flex flex-col items-center justify-center py-16 transition">
                <svg class="w-16 h-16 text-blue-500 dark:text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
                <span class="mt-4 text-lg font-semibold text-blue-700 dark:text-blue-300">点击此处选择 MP3 文件</span>
                <p class="text-xs text-slate-500 dark:text-slate-400 mt-2">歌词将从MP3内嵌数据读取</p>
            </label>
        </div>
        <input type="file" id="fileInput" class="hidden" accept=".mp3">

        <header class="text-center py-2 flex-shrink-0 flex items-center justify-between px-2 sm:px-0">
            <div class="flex items-center"> 
                <button id="muteBtn" type="button" aria-label="静音" class="p-2 rounded-full text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200">
                    <svg id="volumeIcon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 sm:h-6 sm:w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" /></svg>
                    <svg id="muteIcon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 sm:h-6 sm:w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15zM17 14l2-2m0 0l2-2m-2 2l-2 2m2-2l2 2" /></svg>
                </button>
                <input type="range" id="volume-slider" aria-label="音量" min="0" max="1" value="1" step="0.01" class="w-20 sm:w-24 ml-2">
            </div>
            <h1 class="text-xl sm:text-2xl font-bold text-slate-800 dark:text-slate-100 truncate flex-grow text-center mx-4" id="fileName">MP3 播放器</h1>
            <div class="flex justify-end items-center">
                 <button id="togglePlaylistBtn" type="button" title="切换播放列表" class="mr-2 p-2 rounded-full text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 sm:h-6 sm:w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 10h16M4 14h16M4 18h16" /></svg>
                </button>
                <button id="theme-toggle" type="button" aria-label="切换深色模式" class="p-2 rounded-full focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 dark:focus:ring-offset-slate-800 dark:focus:ring-blue-400 text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200 transition-colors">
                    <svg id="theme-icon-light" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 sm:h-6 sm:w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>
                    <svg id="theme-icon-dark" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 sm:h-6 sm:w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
                </button>
            </div>
        </header>

        <div id="playlist-container-wrapper" class="my-4" style="display: none;"> 
            <div id="playlist-container" class="border rounded-md dark:border-gray-700 text-sm text-slate-700 dark:text-slate-300">
                <h2 class="text-lg font-semibold p-3 border-b dark:border-gray-700">云端播放列表</h2>
                <ul id="playlist-items">
                    <li class="p-3 text-slate-400 dark:text-slate-500">正在加载播放列表...</li>
                </ul>
            </div>
        </div>

        <main id="lyrics-section" class="flex-grow flex flex-col mb-4 overflow-hidden bg-transparent"> 
            <div id="lyricsContainer" class="lyrics-container flex-grow overflow-auto text-base sm:text-lg leading-relaxed sm:leading-loose text-slate-700 dark:text-slate-300 bg-transparent">
                <div class="flex h-full items-center justify-center text-slate-400 dark:text-slate-500">请选择一个文件或从列表播放...</div>
            </div>
            <div class="flex items-center justify-center space-x-4 mt-3 flex-shrink-0">
                <span class="text-sm text-slate-500 dark:text-slate-400">字体:</span>
                <button id="font-decrease" type="button" aria-label="减小歌词字号" class="w-8 h-8 bg-slate-200 hover:bg-slate-300 dark:bg-slate-700 dark:hover:bg-slate-600 rounded-full font-bold text-slate-600 dark:text-slate-300 transition-colors">-</button>
                <button id="font-increase" type="button" aria-label="增大歌词字号" class="w-8 h-8 bg-slate-200 hover:bg-slate-300 dark:bg-slate-700 dark:hover:bg-slate-600 rounded-full font-bold text-slate-600 dark:text-slate-300 transition-colors">+</button>
            </div>
        </main>
        
        <footer class="flex-shrink-0 space-y-4">
             <div class="space-y-2">
                <input type="range" id="progress-bar" aria-label="播放进度" min="0" max="100" value="0" step="0.1">
                <div class="flex justify-between text-xs font-mono text-slate-500 dark:text-slate-400">
                    <span id="current-time">00:00</span>
                    <span id="total-time">00:00</span>
                </div>
            </div>
            <div class="flex items-center justify-around"> 
                <button id="prevBtn" type="button" aria-label="上一首" title="上一首 (P)" class="p-2 rounded-full text-slate-600 hover:bg-slate-200 dark:text-slate-300 dark:hover:bg-slate-700 disabled:opacity-50 disabled:cursor-not-allowed">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12.066 11.2a1 1 0 000 1.6l5.334 4A1 1 0 0019 16V8a1 1 0 00-1.6-.8l-5.333 4zM4.066 11.2a1 1 0 000 1.6l5.334 4A1 1 0 0011 16V8a1 1 0 00-1.6-.8l-5.334 4z" /></svg>
                </button>
                <button id="playPauseBtn" type="button" aria-label="播放" class="bg-blue-500 hover:bg-blue-600 dark:bg-blue-600 dark:hover:bg-blue-700 text-white w-16 h-16 rounded-full shadow-lg flex items-center justify-center transition transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed">
                    <svg id="playIcon" xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"></path></svg>
                    <svg id="pauseIcon" xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="currentColor" class="hidden"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"></path></svg>
                </button>
                <button id="nextBtn" type="button" aria-label="下一首" title="下一首 (N)" class="p-2 rounded-full text-slate-600 hover:bg-slate-200 dark:text-slate-300 dark:hover:bg-slate-700 disabled:opacity-50 disabled:cursor-not-allowed">
                     <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M11.933 12.8a1 1 0 000-1.6L6.6 7.2A1 1 0 005 8v8a1 1 0 001.6.8l5.333-4zM19.933 12.8a1 1 0 000-1.6l-5.333-4A1 1 0 0013 8v8a1 1 0 001.6.8l5.333-4z" /></svg>
                </button>
                <div class="flex items-center space-x-2 w-1/4">
                    <label for="speed-slider" id="speed-label-text" class="text-xs text-slate-500 dark:text-slate-400">速度</label>
                    <input type="range" id="speed-slider" aria-labelledby="speed-label-text" min="0.5" max="2" value="1" step="0.01" class="w-full">
                    <span id="speed-display" class="text-xs font-mono text-slate-600 dark:text-slate-300 w-10 text-center">1.00x</span>
                </div>
            </div>
        </footer>
        <audio id="audioPlayer" class="hidden" preload="metadata"></audio>
    </div>

    <script>
        // DOM 元素引用 (与上个版本基本一致，增加了播放列表相关)
        const audioPlayer = document.getElementById('audioPlayer');
        const fileInput = document.getElementById('fileInput');
        const uploadOverlay = document.getElementById('upload-overlay');
        const fileNameDisplay = document.getElementById('fileName');
        const lyricsContainer = document.getElementById('lyricsContainer');
        const playPauseBtn = document.getElementById('playPauseBtn');
        const playIcon = document.getElementById('playIcon');
        const pauseIcon = document.getElementById('pauseIcon');
        const progressBar = document.getElementById('progress-bar');
        const currentTimeDisplay = document.getElementById('current-time');
        const totalTimeDisplay = document.getElementById('total-time');
        const speedSlider = document.getElementById('speed-slider');
        const speedDisplay = document.getElementById('speed-display');
        const fontIncreaseBtn = document.getElementById('font-increase');
        const fontDecreaseBtn = document.getElementById('font-decrease');
        const themeToggleBtn = document.getElementById('theme-toggle');
        const themeIconLight = document.getElementById('theme-icon-light');
        const themeIconDark = document.getElementById('theme-icon-dark');
        const volumeSlider = document.getElementById('volume-slider');
        const muteBtn = document.getElementById('muteBtn');
        const volumeIcon = document.getElementById('volumeIcon');
        const muteIcon = document.getElementById('muteIcon');
        
        const playlistContainerWrapper = document.getElementById('playlist-container-wrapper'); // 播放列表外层容器
        const playlistItemsContainer = document.getElementById('playlist-items'); 
        const prevBtn = document.getElementById('prevBtn'); 
        const nextBtn = document.getElementById('nextBtn');
        const togglePlaylistBtn = document.getElementById('togglePlaylistBtn');
        
        // 状态变量
        let playlist = []; 
        let currentTrackIndex = -1; // -1 表示没有从播放列表加载歌曲
        let isPlayingFromPlaylist = false; // 标记当前是否正在播放列表中的歌曲

        let parsedLyrics = [];
        let lyricOffset = 0; 
        let currentLyricIndex = -1;
        let isSeeking = false;
        let currentObjectURL = null; 
        let previousVolume = 1;

        // --- 主题和音量控制函数 (保持不变) ---
        function applyTheme(isDark) { /* ... */ }
        function toggleTheme() { /* ... */ }
        function initializeTheme() { /* ... */ }
        function handleVolumeChange() { /* ... */ }
        function toggleMute() { /* ... */ }
        function updateMuteButton(muted, volume) { /* ... */ }
        function initializeVolume() { /* ... */ }
        (function() { // 立即执行函数封装这些不变的函数
            applyTheme = function(isDark) { if (isDark) { document.documentElement.classList.add('dark'); if(themeIconLight) themeIconLight.classList.add('hidden'); if(themeIconDark) themeIconDark.classList.remove('hidden'); if(themeToggleBtn) themeToggleBtn.setAttribute('aria-label', '切换浅色模式'); } else { document.documentElement.classList.remove('dark'); if(themeIconLight) themeIconLight.classList.remove('hidden'); if(themeIconDark) themeIconDark.classList.add('hidden'); if(themeToggleBtn) themeToggleBtn.setAttribute('aria-label', '切换深色模式'); } };
            toggleTheme = function() { const isCurrentlyDark = document.documentElement.classList.contains('dark'); localStorage.setItem('theme', !isCurrentlyDark ? 'dark' : 'light'); applyTheme(!isCurrentlyDark); };
            initializeTheme = function() { const storedTheme = localStorage.getItem('theme'); const prefersDarkScheme = window.matchMedia('(prefers-color-scheme: dark)').matches; if (storedTheme === 'dark' || (!storedTheme && prefersDarkScheme)) { applyTheme(true); } else { applyTheme(false); } };
            handleVolumeChange = function() { const volume = parseFloat(volumeSlider.value); audioPlayer.volume = volume; audioPlayer.muted = volume === 0; updateMuteButton(audioPlayer.muted, volume); localStorage.setItem('playerVolume', volume); if (volume > 0) { previousVolume = volume; } };
            toggleMute = function() { if (audioPlayer.muted || audioPlayer.volume === 0) { audioPlayer.muted = false; audioPlayer.volume = previousVolume > 0 ? previousVolume : 0.5; volumeSlider.value = audioPlayer.volume; } else { previousVolume = audioPlayer.volume; audioPlayer.muted = true; audioPlayer.volume = 0; volumeSlider.value = 0; } updateMuteButton(audioPlayer.muted, audioPlayer.volume); localStorage.setItem('playerVolume', audioPlayer.volume); localStorage.setItem('playerMuted', audioPlayer.muted); };
            updateMuteButton = function(muted, volume) { const isEffectivelyMuted = muted || volume === 0; if (volumeIcon) volumeIcon.classList.toggle('hidden', isEffectivelyMuted); if (muteIcon) muteIcon.classList.toggle('hidden', !isEffectivelyMuted); if (muteBtn) muteBtn.setAttribute('aria-label', isEffectivelyMuted ? '取消静音' : '静音'); };
            initializeVolume = function() { const storedVolume = localStorage.getItem('playerVolume'); const storedMuted = localStorage.getItem('playerMuted') === 'true'; let initialVolume = 1; if (storedVolume !== null) { initialVolume = parseFloat(storedVolume); } audioPlayer.volume = initialVolume; volumeSlider.value = initialVolume; previousVolume = initialVolume > 0 ? initialVolume : 1;  if (storedMuted && initialVolume === 0) { audioPlayer.muted = true; } else if (initialVolume === 0) { audioPlayer.muted = true; } else { audioPlayer.muted = storedMuted; } updateMuteButton(audioPlayer.muted, audioPlayer.volume); };
        })();


        // --- 事件监听 ---
        fileInput.addEventListener('change', handleFileSelect); // 本地文件选择
        if (togglePlaylistBtn) {
            togglePlaylistBtn.addEventListener('click', () => {
                const playlistDiv = document.getElementById('playlist-container-wrapper');
                playlistDiv.style.display = playlistDiv.style.display === 'none' ? 'block' : 'none';
            });
        }
        playPauseBtn.addEventListener('click', togglePlayPause);
        audioPlayer.addEventListener('play', updatePlayIcon);
        audioPlayer.addEventListener('pause', updatePlayIcon);
        audioPlayer.addEventListener('ended', handleAudioEnded);
        audioPlayer.addEventListener('timeupdate', handleTimeUpdate);
        audioPlayer.addEventListener('loadedmetadata', handleMetadataLoaded);
        audioPlayer.addEventListener('error', handleAudioError);
        audioPlayer.addEventListener('volumechange', () => { 
            if (audioPlayer.volume !== parseFloat(volumeSlider.value)) { volumeSlider.value = audioPlayer.volume; }
            updateMuteButton(audioPlayer.muted, audioPlayer.volume);
        });
        
        function endSeek() { if (!audioPlayer.duration || !isSeeking) return; isSeeking = false; handleSeek(); }
        progressBar.addEventListener('input', () => { if (audioPlayer.duration) { isSeeking = true; const time = (progressBar.value / 100) * audioPlayer.duration; currentTimeDisplay.textContent = formatTime(time); } });
        progressBar.addEventListener('change', endSeek);
        progressBar.addEventListener('mouseup', endSeek);
        progressBar.addEventListener('touchend', endSeek, { passive: true });
        progressBar.addEventListener('mousedown', () => { if (audioPlayer.duration) isSeeking = true; });

        speedSlider.addEventListener('input', handleSpeedChange);
        fontIncreaseBtn.addEventListener('click', () => changeFontSize(1));
        fontDecreaseBtn.addEventListener('click', () => changeFontSize(-1));
        if(themeToggleBtn) themeToggleBtn.addEventListener('click', toggleTheme);
        if(volumeSlider) volumeSlider.addEventListener('input', handleVolumeChange);
        if(muteBtn) muteBtn.addEventListener('click', toggleMute);
        if(prevBtn) prevBtn.addEventListener('click', playPreviousRemote); // 用于播放列表
        if(nextBtn) nextBtn.addEventListener('click', playNextRemote);     // 用于播放列表

        document.addEventListener('keydown', (e) => {
            const targetTagName = e.target.tagName.toLowerCase();
            if (targetTagName === 'input' || targetTagName === 'textarea' || e.target.isContentEditable) return;
            
            let canControlAudio = audioPlayer.src && audioPlayer.readyState >= HTMLMediaElement.HAVE_METADATA;
             if (!canControlAudio && playlist.length === 0 && !currentObjectURL) return; // 如果什么都没加载，很多快捷键无效

            switch (e.key) {
                case ' ': e.preventDefault(); togglePlayPause(); break;
                case 'ArrowLeft': e.preventDefault(); if (canControlAudio && audioPlayer.duration) audioPlayer.currentTime = Math.max(0, audioPlayer.currentTime - 5); break;
                case 'ArrowRight': e.preventDefault(); if (canControlAudio && audioPlayer.duration) audioPlayer.currentTime = Math.min(audioPlayer.duration, audioPlayer.currentTime + 5); break;
                case 'm': case 'M': e.preventDefault(); toggleMute(); break;
                case 'p': case 'P': if (isPlayingFromPlaylist && playlist.length > 0) { e.preventDefault(); playPreviousRemote(); } break;
                case 'n': case 'N': if (isPlayingFromPlaylist && playlist.length > 0) { e.preventDefault(); playNextRemote(); } break;
            }
        });
        window.addEventListener('beforeunload', () => { if (currentObjectURL) { URL.revokeObjectURL(currentObjectURL); } });

        // --- 核心播放逻辑 ---
        async function loadPlaylistFromJson() {
            try {
                const response = await fetch('playlist.json'); 
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                playlist = await response.json();
                
                if (playlist.length > 0) {
                    renderPlaylistUI();
                    // 默认不自动加载第一首，等待用户点击播放列表或选择本地文件
                    // loadTrackFromPlaylist(0, false); 
                    // 如果当前没有播放本地文件，则可以隐藏 uploadOverlay
                    if (!currentObjectURL) {
                        uploadOverlay.style.display = 'none';
                        displayMessageInLyrics("请从播放列表选择歌曲，或点击上方按钮选择本地文件。");
                    }
                    updateNavButtonsState();
                } else {
                    displayMessageInLyrics("云端播放列表为空或加载失败。");
                     if(uploadOverlay) uploadOverlay.style.display = 'flex'; 
                }
            } catch (error) {
                console.error("无法加载播放列表:", error);
                displayMessageInLyrics(`加载播放列表失败: ${error.message}`, true);
                 if(uploadOverlay) uploadOverlay.style.display = 'flex';
            }
        }

        function renderPlaylistUI() {
            playlistItemsContainer.innerHTML = ''; 
            if (playlist.length === 0) {
                const li = document.createElement('li'); li.textContent = "播放列表为空";
                li.className = "p-3 text-slate-400 dark:text-slate-500"; playlistItemsContainer.appendChild(li); return;
            }
            playlist.forEach((track, index) => {
                const li = document.createElement('li');
                li.textContent = `${track.id}. ${track.title}`; // 简化显示
                li.dataset.index = index;
                li.addEventListener('click', () => { 
                    loadTrackFromPlaylist(index, true); 
                    const playlistDiv = document.getElementById('playlist-container-wrapper');
                    if (playlistDiv.style.display !== 'none') playlistDiv.style.display = 'none'; // 点歌后自动收起列表
                });
                playlistItemsContainer.appendChild(li);
            });
        }

        function updatePlaylistUISelection(selectedIndex) {
            const items = playlistItemsContainer.querySelectorAll('li');
            items.forEach((item, idx) => {
                item.classList.toggle('playing', idx === selectedIndex);
            });
        }
        
        async function loadTrackFromPlaylist(index, autoPlay = true) {
            if (index >= 0 && index < playlist.length) {
                isPlayingFromPlaylist = true; 
                currentTrackIndex = index; 
                const track = playlist[index];

                if (currentObjectURL) { 
                    URL.revokeObjectURL(currentObjectURL);
                    currentObjectURL = null;
                }
                
                // 音频播放仍然直接使用 R2 URL，这样可以利用浏览器的流式播放和缓存
                // 不会等待整个文件下载完才开始播放音频
                audioPlayer.src = track.url; 
                resetPlayerForNewTrack(track.title || track.url.split('/').pop()); 
                
                // 异步下载 MP3 文件以读取歌词
                // 这个过程不会阻塞音频的加载和播放
                fetchMp3AndReadLyrics(track.url); // 注意这里不再 await，让它在后台进行

                audioPlayer.load(); 
                if (autoPlay) { 
                    const playPromise = audioPlayer.play();
                    if (playPromise !== undefined) {
                        playPromise.catch(error => { console.warn("自动播放被阻止:", error); updatePlayIcon(); });
                    }
                } else { updatePlayIcon(); }
                updatePlaylistUISelection(index);
                if(uploadOverlay) uploadOverlay.style.display = 'none'; 
            }
        }

        function resetPlayerForNewTrack(title) {
            if(progressBar) progressBar.value = 0;
            if(currentTimeDisplay) currentTimeDisplay.textContent = '00:00';
            if(totalTimeDisplay) totalTimeDisplay.textContent = '00:00'; 
            if(fileNameDisplay && title) fileNameDisplay.textContent = title;
            parsedLyrics = []; lyricOffset = 0; currentLyricIndex = -1;
            if(lyricsContainer) lyricsContainer.innerHTML = '<div class="flex h-full items-center justify-center text-slate-400 dark:text-slate-500">准备加载歌词...</div>';
        }
        
        async function fetchMp3AndReadLyrics(mp3Url) {
            console.log(`Attempting to download MP3 from: ${mp3Url} to read embedded lyrics.`);
            displayMessageInLyrics(`正在下载 ${mp3Url.split('/').pop()} 以读取歌词...`); 

            try {
                const response = await fetch(mp3Url); 
                if (!response.ok) {
                    throw new Error(`HTTP error fetching MP3! Status: ${response.status} - ${response.statusText}`);
                }
                const arrayBuffer = await response.arrayBuffer(); 
                const blob = new Blob([arrayBuffer], { type: 'audio/mpeg' }); 

                console.log(`Successfully downloaded MP3 as blob from ${mp3Url}. Size: ${blob.size} bytes. Now reading tags...`);

                return new Promise((resolve) => {
                    if (!window.jsmediatags) {
                        console.error("jsmediatags library is not loaded.");
                        parsedLyrics = []; lyricOffset = 0; renderLyrics(); resolve(); return;
                    }
                    window.jsmediatags.read(blob, {
                        onSuccess: function(tag) {
                            console.log(`Successfully read tags from MP3 blob (${mp3Url}):`, JSON.parse(JSON.stringify(tag))); // 日志输出读取到的所有标签
                            let lyricsText = '';
                            
                            // 优先尝试从 USLT 标签获取歌词
                            if (tag.tags.USLT) {
                                // jsmediatags 可能将 USLT 数据包装在 .data 对象中，或者直接作为 USLT 标签的值
                                const usltData = tag.tags.USLT.data || tag.tags.USLT; 
                                if (usltData && typeof usltData.lyrics === 'string') {
                                    lyricsText = usltData.lyrics;
                                }
                                console.log("Found USLT data object:", usltData); // 打印 USLT 数据对象
                                console.log("Extracted lyricsText from USLT:", lyricsText ? lyricsText.substring(0,100) + "..." : "null/empty");
                            
                            // 如果 USLT 中没有，或者 USLT 标签不存在，尝试非标准的 'lyrics' 标签
                            } else if (tag.tags.lyrics) { 
                                if (typeof tag.tags.lyrics === 'string') {
                                    lyricsText = tag.tags.lyrics;
                                    console.log("Found 'lyrics' tag (string):", lyricsText ? lyricsText.substring(0,100) + "..." : "null/empty");
                                } else if (typeof tag.tags.lyrics === 'object' && typeof tag.tags.lyrics.lyrics === 'string') {
                                    // 兼容某些工具可能将 lyrics 也存为对象 { descriptor: '...', lyrics: '...' }
                                    lyricsText = tag.tags.lyrics.lyrics;
                                    console.log("Found 'lyrics' tag (object with .lyrics property):", lyricsText ? lyricsText.substring(0,100) + "..." : "null/empty");
                                }
                            } else {
                                console.log(`No USLT or 'lyrics' tag found in MP3 blob from ${mp3Url}. Available tags:`, Object.keys(tag.tags));
                            }
                            
                            if (lyricsText && lyricsText.trim()) {
                                console.log("Passing to parseLyrics (first 100 chars):", lyricsText.trim().substring(0,100) + "...");
                                parseLyrics(lyricsText.trim());
                            } else {
                                console.log("lyricsText is empty or null after attempting to extract from tags, clearing parsedLyrics.");
                                parsedLyrics = []; lyricOffset = 0;
                            }
                            renderLyrics();
                            resolve();
                        },
                        onError: function(error) {
                            console.error(`从 MP3 blob (${mp3Url}) 读取标签失败:`, error);
                            parsedLyrics = []; lyricOffset = 0; renderLyrics(); 
                            resolve();
                        }
                    });
                });

            } catch (error) {
                console.error(`下载 MP3 (${mp3Url}) 失败:`, error);
                parsedLyrics = []; lyricOffset = 0; renderLyrics(); 
                return Promise.resolve(); 
            }
        }
        // 本地文件选择处理 (恢复并调整)
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file && file.type === "audio/mpeg") {
                isPlayingFromPlaylist = false; // 标记为本地播放
                currentTrackIndex = -1; // 重置云端列表索引
                updatePlaylistUISelection(-1); // 取消播放列表高亮

                if (currentObjectURL) URL.revokeObjectURL(currentObjectURL);
                currentObjectURL = URL.createObjectURL(file);
                
                audioPlayer.src = currentObjectURL;
                resetPlayerForNewTrack(file.name); // 使用本地文件名
                
                displayMessageInLyrics("正在从本地文件加载歌词...");
                loadLyricsFromLocalFile(file); // 使用 jsmediatags 读取本地文件歌词

                audioPlayer.load();
                const playPromise = audioPlayer.play(); // 本地选择后通常期望自动播放
                if (playPromise !== undefined) {
                    playPromise.catch(error => { console.warn("本地文件自动播放被阻止:", error); updatePlayIcon(); });
                }
                uploadOverlay.style.display = 'none';
                fileInput.value = ''; 
            } else if (file) {
                alert("请选择一个 MP3 文件。");
                fileInput.value = '';
            }
        }

        // 从本地 File 对象加载歌词 (之前叫 loadLyrics)
        function loadLyricsFromLocalFile(fileObject) {
             window.jsmediatags.read(fileObject, {
                onSuccess: function(tag) {
                    let lyricsText = '';
                    if (tag.tags.lyrics) { lyricsText = (typeof tag.tags.lyrics === 'object' ? tag.tags.lyrics.lyrics : tag.tags.lyrics); }
                    else if (tag.tags.USLT) { lyricsText = (typeof tag.tags.USLT === 'object' ? tag.tags.USLT.lyrics : tag.tags.USLT); }
                    
                    if (lyricsText && typeof lyricsText === 'string' && lyricsText.trim()) {
                        parseLyrics(lyricsText.trim());
                    } else { parsedLyrics = []; lyricOffset = 0; }
                    renderLyrics();
                },
                onError: (error) => {
                    console.error('读取本地 MP3 标签错误:', error);
                    parsedLyrics = []; lyricOffset = 0; renderLyrics();
                }
            });
        }

        // 恢复歌词解析和渲染相关函数
        function parseLyrics(text) { /* ... (你的原版实现) ... */ }
        function renderLyrics() { /* ... (你的原版实现) ... */ }
        function handleLyricLineClick(event) { /* ... (你的原版实现) ... */ }
        function updateLyricHighlight() { /* ... (你的原版实现) ... */ }
        (function() { // 立即执行函数封装这些不变的函数
            parseLyrics = function(text) { parsedLyrics = []; lyricOffset = 0; const lines = text.split('\n'); const timeRegex = /\[(\d{1,2}):(\d{2})(?:[.:](\d{1,3}))?\](.*)/; const offsetRegex = /\[offset:\s*([+-]?\d+)\]/i; for (const line of lines) { const offsetMatch = offsetRegex.exec(line); if (offsetMatch) { lyricOffset = parseInt(offsetMatch[1]) / 1000; continue; } const match = timeRegex.exec(line.trim()); if (match) { const minutes = parseInt(match[1]); const seconds = parseInt(match[2]); const millisecondsString = match[3] ? match[3].padEnd(3, '0') : '000'; const milliseconds = parseInt(millisecondsString.substring(0,3)); let time = minutes * 60 + seconds + milliseconds / 1000; const textContent = match[4].trim(); if (textContent) { parsedLyrics.push({ time, text: textContent }); } } } parsedLyrics.sort((a, b) => a.time - b.time); if (lyricOffset !== 0) { parsedLyrics.forEach(line => line.time += lyricOffset); parsedLyrics = parsedLyrics.filter(line => line.time >=0); } };
            renderLyrics = function() { lyricsContainer.innerHTML = ''; if (parsedLyrics.length === 0) { lyricsContainer.innerHTML = `<div class="flex h-full items-center justify-center text-slate-400 dark:text-slate-500">（此歌曲暂无歌词或加载失败）</div>`; return; } parsedLyrics.forEach((line, index) => { const p = document.createElement('p'); p.textContent = line.text; p.dataset.time = line.time; p.dataset.index = index; p.addEventListener('click', handleLyricLineClick); lyricsContainer.appendChild(p); }); updateLyricHighlight(); };
            handleLyricLineClick = function(event) { if (!audioPlayer.src || audioPlayer.readyState < HTMLMediaElement.HAVE_CURRENT_DATA || parsedLyrics.length === 0) return; const targetLine = event.currentTarget; const timeString = targetLine.dataset.time; const indexString = targetLine.dataset.index; if (timeString !== undefined && indexString !== undefined) { const time = parseFloat(timeString); const newClickedIndex = parseInt(indexString); if (!isNaN(time) && time >= 0 && time <= audioPlayer.duration && !isNaN(newClickedIndex)) { audioPlayer.currentTime = time; const allLineElements = lyricsContainer.querySelectorAll('p[data-index]'); if (currentLyricIndex > -1 && allLineElements[currentLyricIndex]) { allLineElements[currentLyricIndex].classList.remove('active'); } targetLine.classList.add('active'); currentLyricIndex = newClickedIndex; targetLine.scrollIntoView({ behavior: 'smooth', block: 'center' }); if (audioPlayer.paused) { audioPlayer.play(); } } } };
            updateLyricHighlight = function() { if (!parsedLyrics.length || !audioPlayer.duration || isSeeking) return; const currentTime = audioPlayer.currentTime; let newIndex = -1; for (let i = parsedLyrics.length - 1; i >= 0; i--) { if (parsedLyrics[i].time <= currentTime + 0.3) { newIndex = i; break; } } if (newIndex === -1 && parsedLyrics.length > 0 && currentTime < parsedLyrics[0].time) { newIndex = -1; } if (newIndex !== currentLyricIndex) { const allLineElements = lyricsContainer.querySelectorAll('p[data-index]'); if (currentLyricIndex > -1 && allLineElements[currentLyricIndex]) { allLineElements[currentLyricIndex].classList.remove('active'); } currentLyricIndex = newIndex; if (currentLyricIndex > -1 && allLineElements[currentLyricIndex]) { const currentLineElement = allLineElements[currentLyricIndex]; currentLineElement.classList.add('active'); const containerRect = lyricsContainer.getBoundingClientRect(); const lineRect = currentLineElement.getBoundingClientRect(); const lineHeight = lineRect.height; const lineCenterY = lineRect.top + lineHeight / 2; const containerCenterY = containerRect.top + containerRect.height / 2; const isCenteredEnough = Math.abs(lineCenterY - containerCenterY) < (lineHeight * 0.75); if (!isCenteredEnough) { currentLineElement.scrollIntoView({ behavior: 'smooth', block: 'center' }); } } } };
        })();


        // --- 其他播放控制函数 ---
        function playNextRemote() {
            if (!isPlayingFromPlaylist || playlist.length === 0) return;
            let nextIndex = currentTrackIndex + 1;
            if (nextIndex >= playlist.length) nextIndex = 0; // Loop playlist
            loadTrackFromPlaylist(nextIndex, true);
        }
        function playPreviousRemote() {
            if (!isPlayingFromPlaylist || playlist.length === 0) return;
            let prevIndex = currentTrackIndex - 1;
            if (prevIndex < 0) prevIndex = playlist.length - 1; // Loop playlist
            loadTrackFromPlaylist(prevIndex, true);
        }
        function togglePlayPause() {
            // 如果当前没有加载任何音频 (无论是本地还是列表)，并且列表已加载，则尝试播放列表第一首
            if (!audioPlayer.currentSrc && playlist.length > 0 && !currentObjectURL) {
                 loadTrackFromPlaylist(0, true);
                 return;
            }
            // 如果没有加载任何音频，并且列表也未加载/为空，允许用户点击上传
            if (!audioPlayer.currentSrc && playlist.length === 0 && !currentObjectURL) {
                if (uploadOverlay && uploadOverlay.style.display === 'none') {
                    uploadOverlay.style.display = 'flex';
                } else if (uploadOverlay) { // 如果 overlay 可见，模拟点击 label
                    const label = uploadOverlay.querySelector('label');
                    if (label) label.click();
                }
                return;
            }

            if (audioPlayer.ended) audioPlayer.currentTime = 0;
            audioPlayer.paused ? audioPlayer.play() : audioPlayer.pause();
        }
        function updatePlayIcon() {
            const canPlay = audioPlayer.currentSrc || (playlist.length > 0 && currentTrackIndex >=0) || currentObjectURL;
            playPauseBtn.disabled = !canPlay;
            if (!canPlay) {
                playIcon.classList.remove('hidden'); pauseIcon.classList.add('hidden');
                playPauseBtn.setAttribute('aria-label', '播放'); return;
            }
            const isEffectivelyPaused = audioPlayer.paused || audioPlayer.ended;
            playIcon.classList.toggle('hidden', !isEffectivelyPaused);
            pauseIcon.classList.toggle('hidden', isEffectivelyPaused);
            playPauseBtn.setAttribute('aria-label', isEffectivelyPaused ? '播放' : '暂停');
        }
        function handleAudioEnded() {
            if (isPlayingFromPlaylist) {
                playNextRemote();
            } else {
                // 本地文件播放结束，回到播放图标，时间归零 (或根据需要设置单曲循环)
                updatePlayIcon();
                if (audioPlayer.duration) {
                     currentTimeDisplay.textContent = formatTime(audioPlayer.duration);
                     progressBar.value = 100;
                }
            }
        }
        function handleTimeUpdate() { if (!isSeeking && audioPlayer.duration) { progressBar.value = (audioPlayer.currentTime / audioPlayer.duration) * 100 || 0; } if(!isSeeking){ currentTimeDisplay.textContent = formatTime(audioPlayer.currentTime); } updateLyricHighlight(); }
        function handleMetadataLoaded() { totalTimeDisplay.textContent = formatTime(audioPlayer.duration); progressBar.value = 0; if(audioPlayer.currentSrc) playPauseBtn.disabled = false; initializeVolume(); }
        function handleSeek() { if (audioPlayer.duration) { const targetTime = (progressBar.value / 100) * audioPlayer.duration; audioPlayer.currentTime = targetTime; if (audioPlayer.paused) { updateLyricHighlight(); currentTimeDisplay.textContent = formatTime(targetTime); } } }
        function handleSpeedChange() { const speed = parseFloat(speedSlider.value); audioPlayer.playbackRate = speed; speedDisplay.textContent = speed.toFixed(2) + 'x'; }
        function changeFontSize(amount) { const cs = parseFloat(window.getComputedStyle(lyricsContainer).fontSize); const ns = cs + amount; if (ns >= 10 && ns <= 40) { lyricsContainer.style.fontSize = ns + 'px'; } }
        function formatTime(seconds) { const fs = Math.floor(seconds || 0); const m = Math.floor(fs / 60); const s = fs % 60; return `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`; }
        function displayMessageInLyrics(message, isError = false) { lyricsContainer.innerHTML = `<div class="flex h-full items-center justify-center p-4 text-center ${isError ? 'text-red-500' : 'text-slate-400 dark:text-slate-500'}">${message}</div>`; }
        function resetPlayer() { audioPlayer.pause(); audioPlayer.currentTime = 0; updatePlayIcon(); if(progressBar) progressBar.value = 0; if(currentTimeDisplay) currentTimeDisplay.textContent = '00:00'; if(totalTimeDisplay) totalTimeDisplay.textContent = '00:00'; if(speedSlider) speedSlider.value = 1; audioPlayer.playbackRate = 1; if(speedDisplay) speedDisplay.textContent = '1.00x'; if (lyricsContainer && lyricsContainer.style.fontSize) { lyricsContainer.style.fontSize = ''; } parsedLyrics = []; lyricOffset = 0; currentLyricIndex = -1; isSeeking = false; }
        function handleAudioError(e) { console.error("Audio Player Error:", audioPlayer.error, e); let trackTitle = isPlayingFromPlaylist && playlist[currentTrackIndex] ? playlist[currentTrackIndex].title : (currentObjectURL ? "本地文件" : "当前歌曲"); let msg = `播放 ${trackTitle} 时发生错误。`; if (audioPlayer.error) { switch (audioPlayer.error.code) { case MediaError.MEDIA_ERR_ABORTED: msg += "播放已中止。"; break; case MediaError.MEDIA_ERR_NETWORK: msg += "网络错误。"; break; case MediaError.MEDIA_ERR_DECODE: msg += "解码错误。"; break; case MediaError.MEDIA_ERR_SRC_NOT_SUPPORTED: msg += "音频源或格式不支持。"; break; default: msg += `未知错误 (代码: ${audioPlayer.error.code})。`; } } displayMessageInLyrics(msg, true); if(fileNameDisplay) fileNameDisplay.textContent = "播放错误"; resetPlayerUIForError(); }
        function resetPlayerUIForError() { audioPlayer.pause(); updatePlayIcon(); if(progressBar) progressBar.value = 0; }
        function updateNavButtonsState() {
            const disabled = !(isPlayingFromPlaylist && playlist.length > 0);
            if(prevBtn) prevBtn.disabled = disabled;
            if(nextBtn) nextBtn.disabled = disabled;
        }

        // --- 初始加载 ---
        document.addEventListener('DOMContentLoaded', () => {
            initializeTheme();
            updatePlayIcon(); // 初始化播放按钮状态
            updateNavButtonsState(); // 初始化导航按钮状态
            loadPlaylistFromJson(); // 尝试加载云端播放列表
        });
    </script>
</body>
</html>